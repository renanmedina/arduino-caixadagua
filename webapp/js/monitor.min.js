var time_interval,SystemMonitor={_currentConfig:{},isChartRendered:!1,bindConfigsFormValues:function(){for(var e in this._currentConfig){var a=this.getConfig(e);document.getElementsByName(e)[0].value=a}},actions:{SAVE_SETTINGS:"SS",DELETE_LOGS:"DL",LOAD_LOGS_TABLE:"LT"},getInfo:function(e,a){$.ajax({url:this.getConfig("datasource"),type:"GET",timeout:2e3,success:function(a){var t=a.split(";"),n={};for(var o in t){var s=t[o].split(":");n[s[0]]=s[1]}e(n)},error:function(e){a(e)}})},loadConfig:function(e){var a=this;$.ajax({url:"configs.json",type:"GET",dateType:"json",success:function(t){try{var n=JSON.parse(t)}catch(e){var n=t}finally{a._currentConfig=n,n&&e(n)}},error:function(e){console.log(e)}})},getConfig:function(e){return void 0!==this._currentConfig[e]?this._currentConfig[e]:null},loadLogsTable:function(){$("#logs-table").DataTable({ajax:"actions.php?action="+this.actions.LOAD_LOGS_TABLE,searching:!1,processing:!0,serverSide:!0,language:{url:"//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Portuguese.json"}})},refreshLogsTable:function(){$("#logs-table").DataTable().draw()},clearLogs:function(){confirm("Desejar realmente excluir todos os historicos ?")&&$.ajax({url:"actions.php",type:"POST",data:{action:this.actions.DELETE_LOGS},success:function(e){e=JSON.parse(e),e.num_logs&&(alert("CONCLUIDO!!! \n\n"+e.num_logs+" logs foram apagados no total."),SystemMonitor.refreshLogsTable())},error:function(e){}})},saveSettings:function(){var e=$("#settings-form").serialize();$.ajax({url:"actions.php",data:{action:this.actions.SAVE_SETTINGS,settings:e},type:"POST",success:function(e){SystemMonitor.loadConfig(function(){alert("Aplicado com sucesso !")})}})},getInfoAndRenderCharts:function(e){document.getElementById("runtime").innerHTML=(new Date).toString("dd/MM/yyyy HH:mm");var a=document.getElementById("sys-mode");SystemMonitor.isChartRendered||(a.classList.remove("alert-danger"),a.classList.remove("alert-success"),a.classList.remove("alert-warning"),a.classList.add("alert-info"),a.innerHTML="<i class='fa fa-refresh fa-spin'></i> carregando ..."),this.getInfo(function(e){a.classList.remove("alert-danger"),a.classList.remove("alert-success"),a.classList.remove("alert-warning"),a.classList.remove("alert-info");var t=e.system_mode;a.innerHTML=0==t?"<i class='fa fa-thumbs-down'></i> <b>DESLIGADO</b>":1==t?"<i class='fa fa-thumbs-up'></i> <b>AUTOMATICO</b>":"<i class='fa fa-user'></i> <b>MANUAL</b>";var n=0==t?"alert-danger":1==t?"alert-success":"alert-warning";a.classList.add(n);var o={type:"cylinder",dataFormat:"json",renderAt:"gwater",width:"100%",dataSource:{chart:{animation:0,theme:"fint",bgColor:"#ffffff",baseFontSize:"12",showBorder:"0",cylFillColor:"#74ccf4",lowerLimit:"0",upperLimit:"100",numberSuffix:"%",showValue:"1",cylradius:"100"},value:e.current_level}},s={type:"hlineargauge",dataFormat:"json",renderAt:"gpump",height:"65px",width:"100%",dataSource:{chart:{animation:0,theme:"fint",showGaugeBorder:"1",gaugeBorderColor:"{light-50}",gaugeBorderThickness:"4",gaugeBorderAlpha:"100",baseFontSize:"18",baseFontColor:"#fff",bgColor:"#ffffff",showBorder:"0",showTickMarks:"0",showTickValues:"0",showValue:"0"},colorRange:{color:[{minValue:0,maxValue:50,label:"Desligada",code:"#e74c3c"},{minValue:51,maxValue:100,label:"Ligada",code:"#2ecc71"}]},pointers:{pointer:[{value:e.pump_state}]}}};SystemMonitor.isChartRendered?($("#gwater").updateFusionCharts(o),$("#gpump").updateFusionCharts(s)):($("#gwater").insertFusionCharts(o),$("#gpump").insertFusionCharts(s),SystemMonitor.isChartRendered=!0)},function(e){a.classList.add("alert-danger"),a.innerHTML='<i class="fa fa-unlink"></i> OFFLINE',$("#gwater").html("<div class='alert alert-danger'><i class='fa fa-ban'></i> Nao foi possivel carregar o nivel da caixa, favor verifique o status/conexao do <b>arduino</b>.</div>"),$("#gpump").html("<div class='alert alert-danger'><i class='fa fa-ban'></i> Nao foi possivel carregar o estado da bomba, favor verifique o status/conexao do <b>arduino</b>.</div>"),SystemMonitor.isChartRendered=!1})},init:function(){this.loadConfig(function(){time_interval=1e3*SystemMonitor.getConfig("updateInterval"),SystemMonitor.bindConfigsFormValues(),SystemMonitor.getInfoAndRenderCharts(),SystemMonitor.loadLogsTable();var e=function(){SystemMonitor.getInfoAndRenderCharts(),time_interval=1e3*SystemMonitor.getConfig("updateInterval"),window.clearInterval(a),a=window.setInterval(e,time_interval)},a=window.setInterval(e,time_interval)})}};$(document).ready(function(){$("#tabs li a").click(function(){$("#tabs li").removeClass("active"),$(this).parent().addClass("active");var e=$(this).attr("tab-id");$(".tab-content").removeClass("visible"),$(".tab-content#"+e).addClass("visible")}),SystemMonitor.init()});